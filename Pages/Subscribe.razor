


<div class="u-clearfix u-image u-shading u-section-1" id="sec-6585" data-image-width="1280" data-image-height="1280">
    <div class="u-clearfix u-sheet u-sheet-1">
        <div class="u-align-center u-container-style u-group u-shape-rectangle u-group-1">
            <div class="u-container-layout u-container-layout-1">
                <span class="u-file-icon u-icon u-icon-rectangle u-text-grey-5 u-icon-1"><img src="css/images/2838794-172134cb.png" alt=""></span>
                <h1 class="u-text u-text-default u-text-1">اضافة اشتراك</h1>
                <div class="u-align-center u-form u-form-1">
                    <EditForm Model="subscribe" OnValidSubmit="Save" action="https://forms.nicepagesrv.com/Form/Process" class="u-clearfix u-form-spacing-41 u-form-vertical u-inner-form" source="email" name="form" style="padding: 0px;">
                        <div class="u-form-date u-form-group u-form-partition-factor-2">
                            <label for="name-c6a3" class="u-label u-label-2">تاريخ بداية الاشتراك</label>
                            <input  @bind-value="subscribe.Date" type="date" id="name-c6a3" name="name" class="u-border-1 u-border-grey-30 u-grey-90 u-input u-input-rectangle u-radius-6 u-input-2" required="required">
                        </div>
                        <div class="u-form-date u-form-group u-form-partition-factor-2">
                            <label for="email-c6a3" class="u-label u-label-1">تاريخ نهاية الاشتراك</label>
                            <input  @bind-value="subscribe.DateEnd" type="date" id="email-c6a3" name="email" class="u-border-1 u-border-grey-30 u-grey-90 u-input u-input-rectangle u-radius-6 u-input-1" required="required">
                        </div>
                        <div class="u-form-group u-form-partition-factor-2 u-form-group-3">
                            <label for="text-779a" class="u-label u-label-3">المدفوع</label>
                            <input @bind-value="subscribe.Paid" type="text" id="text-779a" name="text" class="u-border-1 u-border-grey-30 u-grey-90 u-input u-input-rectangle u-radius-6 u-input-3">
                        </div>
                        <div class="u-form-group u-form-partition-factor-2 u-form-group-4">
                            <label for="phone-84d9" class="u-label u-label-4">مدة الاشتراك</label>
                            <input readonly  @bind-value="subscribe.SubscriptionPeriod" type="text" pattern="\+?\d{0,3}[\s\(\-]?([0-9]{2,3})[\s\)\-]?([\s\-]?)([0-9]{3})[\s\-]?([0-9]{2})[\s\-]?([0-9]{2})" placeholder="مدة الاشتراك بالايام" id="phone-84d9" name="phone" class="u-border-1 u-border-grey-30 u-grey-90 u-input u-input-rectangle u-radius-6 u-input-4" required="required">
                        </div>
                        <div class="u-form-group u-form-partition-factor-2 u-form-group-5">
                            <label for="text-9ddf" class="u-label u-label-5">المجموع</label>
                            <input required @bind-value="subscribe.Total" type="text" placeholder="" id="text-9ddf" name="text-2" class="u-border-1 u-border-grey-30 u-grey-90 u-input u-input-rectangle u-radius-6 u-input-5">
                        </div>
                        <div class="u-form-group u-form-partition-factor-2 u-form-group-6">
                            <label for="text-723f" class="u-label u-label-6">غير المدفوع</label>
                            <input readonly @bind-value="subscribe.Unpaid" type="text" placeholder="" id="text-723f" name="text-1" class="u-border-1 u-border-grey-30 u-grey-90 u-input u-input-rectangle u-radius-6 u-input-6">
                        </div>
                        <div class="u-align-center u-form-group u-form-submit">
                            <button type="submit" class="u-btn u-btn-round u-btn-submit u-button-style u-palette-4-base u-radius-50 u-btn-1">
                                اضافة<br>
                            </button>
                        </div>
                        <div class="u-form-send-message u-form-send-success"> Thank you! Your message has been sent. </div>
                        <div class="u-form-send-error u-form-send-message"> Unable to send your message. Please fix errors then try again. </div>
                        <input type="hidden" value="" name="recaptchaResponse">
                        <input type="hidden" name="formServices" value="e9f7d5cc5d85871f7e2d425d88d612ac">
                    </EditForm>
                </div><span class="u-file-icon u-icon u-text-white u-icon-2"><img src="css/images/925748-477b82f9.png" alt=""></span><span class="u-file-icon u-icon u-text-white u-icon-3"><img src="css/images/925748-477b82f9.png" alt=""></span><span class="u-file-icon u-icon u-text-white u-icon-4"><img src="css/images/925748-477b82f9.png" alt=""></span><span class="u-file-icon u-icon u-text-grey-5 u-icon-5"><img src="css/images/661512-e3470faa.png" alt=""></span><span class="u-file-icon u-icon u-text-grey-5 u-icon-6"><img src="css/images/661512-e3470faa.png" alt=""></span><span class="u-file-icon u-icon u-text-grey-5 u-icon-7"><img src="css/images/661512-e3470faa.png" alt=""></span>
                <a href="/" class="u-btn u-button-style u-hover-palette-3-base u-palette-2-base u-btn-2">
                    <span class="u-icon u-text-white u-icon-8"><svg class="u-svg-content" viewBox="0 0 512 512" x="0px" y="0px" style="width: 1em; height: 1em;"><polygon points="256,152.96 79.894,288.469 79.894,470.018 221.401,470.018 221.401,336.973 296.576,336.973 296.576,470.018 432.107,470.018 432.107,288.469"></polygon><polygon points="439.482,183.132 439.482,90.307 365.316,90.307 365.316,126.077 256,41.982 0,238.919 35.339,284.855 256,115.062 476.662,284.856 512,238.92"></polygon></svg><img></span>
                </a>
            </div>


        </div>

    </div>

</div>



@code {
    [Parameter]
    public TraineeInfoModel TraineeInfo { get; set; } = new TraineeInfoModel();

    [Parameter]
    public int IdSub { get; set; }

    public SubscribeModel subscribe { get; set; } = new SubscribeModel();

    [Inject]
    public SubscribeRepository subscribeRepository { get; set; }

    [Inject]
    public IToastService toastService { get; set; }

    [CascadingParameter] BlazoredModalInstance BlazoredModal { get; set; } = default!;


    protected override void OnInitialized()
    {
        subscribe.Date = DateTime.Now;
        subscribe.DateEnd = DateTime.Now;

        subscribe.Total = null;
        SubscribeModel sub = new SubscribeModel();
        if (subscribeRepository.CheckIfSubscbiveIsActive(TraineeInfo.SubscribeTrainee , out sub))
        {

            subscribe.Date = sub.DateEnd;
            subscribe.DateEnd = sub.DateEnd;
        }

        if (IdSub !=null && IdSub != 0)
        {
            var subfound = TraineeInfo.SubscribeTrainee.Find(w=>w.Id == IdSub);



            subscribe = subfound;

        }


    }



    private void Save()
    {
        if(IdSub != null && IdSub != 0)
        {
            subscribe.Unpaid = subscribe.Total.Value - subscribe.Paid.Value;
            subscribeRepository.Update(IdSub);
            Close();
        }
        else
        {
            AddSubscribe();
        }
    }




    private void AddSubscribe()
    {

        var days = (subscribe.DateEnd - subscribe.Date).TotalDays;
        subscribe.SubscriptionPeriod = (int)days;
        subscribe.Unpaid = subscribe.Total.Value - subscribe.Paid.Value;
        subscribe.IdParent = TraineeInfo.Id;

        if (subscribeRepository.SubscribeTimeInFuture(subscribe.DateEnd))
        {
            //add to database
            subscribeRepository.AddSubscribe(subscribe);

            Close();

        }
        else
        {
            toastService.ShowWarning("يجب ان يكون تاريخ نهاية الاشتراك في المستقبل");
        }

    }

    private async Task Close() => await BlazoredModal.CloseAsync(ModalResult.Ok(true));



}


}